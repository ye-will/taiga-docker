#!/bin/bash
set -e

POSTGRES_DB_NAME=${POSTGRES_DB_NAME:-$POSTGRES_ENV_POSTGRES_USER}
POSTGRES_USER=${POSTGRES_USER:-$POSTGRES_ENV_POSTGRES_USER}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-$POSTGRES_ENV_POSTGRES_PASSWORD}
POSTGRES_HOST=${POSTGRES_HOST:-$POSTGRES_PORT_5432_TCP_ADDR}
POSTGRES_PORT=${POSTGRES_PORT:-5432}

SCHEME=${SCHEME:-http}
DOMAIN=${DOMAIN:-$HOSTNAME}
MEDIA_URL=${MEDIA_URL:-$SCHEME://$DOMAIN/media/}
STATIC_URL=${STATIC_URL:-$SCHEME://$DOMAIN/static/}
FRONT_NAME=${FRONT_NAME:-front}
API_NAME=${API_NAME:-api}
SECRET_KEY=${SECRET_KEY:-insecurekey}
EMAIL_USE_TLS=${EMAIL_USE_TLS:-False}
EMAIL_HOST=${EMAIL_HOST:-localhost}
EMAIL_PORT=${EMAIL_PORT:-25}
EMAIL_HOST_USER=${EMAIL_HOST_USER:-}
EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD:-}
DEFAULT_FROM_EMAIL=${DEFAULT_FROM_EMAIL:-no-reply@example.com}
DEBUG=${DEBUG:-False}
TEMPLATE_DEBUG=${TEMPLATE_DEBUG:-False}
PUBLIC_REGISTER_ENABLED=${PUBLIC_REGISTER_ENABLED:-True}

cat > /usr/local/taiga/taiga-back/settings/dockerenv.py <<EOL
from .common import *

DATABASES = {
   'default': {
       'ENGINE': 'django.db.backends.postgresql',
       'NAME': '${POSTGRES_DB_NAME}',
       'USER': '${POSTGRES_USER}',
       'PASSWORD': '${POSTGRES_PASSWORD}',
       'HOST': '${POSTGRES_HOST}',
       'PORT': '${POSTGRES_PORT}',
   }
}

HOST = '${SCHEME}://${DOMAIN}/'

MEDIA_ROOT = '/usr/local/taiga/media'
MEDIA_URL = '${MEDIA_URL}'

STATIC_ROOT = '/usr/local/taiga/static'
STATIC_URL = '${STATIC_URL}'
ADMIN_MEDIA_PREFIX = '${STATIC_URL}admin/'

SITES["front"]["scheme"] = '${SCHEME}'
SITES["front"]["domain"] = '${DOMAIN}'
SITES["front"]["name"] = '${FRONT_NAME}'

SITES["api"]["scheme"] = '${SCHEME}'
SITES["api"]["domain"] = '${DOMAIN}'
SITES["api"]["name"] = '${API_NAME}'

SECRET_KEY = '${SECRET_KEY}'

EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_USE_TLS = ${EMAIL_USE_TLS}
EMAIL_HOST = '${EMAIL_HOST}'
EMAIL_PORT = ${EMAIL_PORT}
EMAIL_HOST_USER = '${EMAIL_HOST_USER}'
EMAIL_HOST_PASSWORD = '${EMAIL_HOST_PASSWORD}'

DEFAULT_FROM_EMAIL = '${DEFAULT_FROM_EMAIL}'

DEBUG = ${DEBUG}
TEMPLATE_DEBUG = ${TEMPLATE_DEBUG}
PUBLIC_REGISTER_ENABLED = ${PUBLIC_REGISTER_ENABLED}
EOL
